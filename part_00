# OpenSpec Day 7 学习笔记：深入原理

## 学习日期
2026-02-18

---

## Part 1: Delta Spec 机制

### 1.1 Delta Spec 格式定义

**数据结构**（`src/core/schemas/change.schema.ts`）：
```typescript
export const DeltaOperationType = z.enum(['ADDED', 'MODIFIED', 'REMOVED', 'RENAMED']);

export const DeltaSchema = z.object({
  spec: z.string(),           // 目标 spec 名称
  operation: DeltaOperationType,
  description: z.string(),    // 描述
  requirement: RequirementSchema.optional(),
  requirements: z.array(RequirementSchema).optional(),
  rename: z.object({ from, to }).optional(),  // RENAMED 专用
});
```

**四种操作类型：**
1. **ADDED**: 新增需求
2. **MODIFIED**: 修改现有需求
3. **REMOVED**: 删除需求
4. **RENAMED**: 重命名需求（包含 FROM 和 TO）

### 1.2 Delta Spec 解析

**解析器**（`src/core/parsers/change-parser.ts`）：

解析流程：
1. 识别 Delta 章节：`## ADDED Requirements`、`## MODIFIED Requirements` 等
2. 提取需求块：`### Requirement: <name>`
3. 提取场景：`#### Scenario: <name>`
4. 解析 RENAME：`FROM: ### Requirement: <old>` 和 `TO: ### Requirement: <new>`

```typescript
private parseSpecDeltas(specName: string, content: string): Delta[] {
  const sections = this.parseSectionsFromContent(content);

  // 解析 ADDED
  const addedSection = this.findSection(sections, 'ADDED Requirements');
  if (addedSection) {
    const requirements = this.parseRequirements(addedSection);
    requirements.forEach(req => {
      deltas.push({
        spec: specName,
        operation: 'ADDED',
        description: `Add requirement: ${req.text}`,
        requirement: req,
        requirements: [req],
      });
    });
  }

  // 解析 MODIFIED、REMOVED、RENAMED（类似）
  // ...
}
```

### 1.3 Delta Spec 验证

**验证器**（`src/core/validation/validator.ts`）：

验证规则：
1. **章节内重复检查**：ADDED/MODIFIED/REMOVED/RENAMED 中不能有重复的需求名称
2. **跨章节冲突检查**：同一需求不能出现在多个章节
3. **格式要求**：
   - ADDED/MODIFIED：必须有需求文本（SHALL/MUST），必须有至少一个场景
   - REMOVED：只需要名称，不需要场景
   - RENAMED：必须有 FROM 和 TO 配对

```typescript
// 跨章节冲突检查示例
for (const n of modifiedNames) {
  if (removedNames.has(n)) {
    issues.push({
      level: 'ERROR',
      path: entryPath,
      message: `Requirement present in both MODIFIED and REMOVED: "${n}"`
    });
  }
}
```

### 1.4 Delta Spec 合并

**合并逻辑**（`src/core/specs-apply.ts`）：

**合并顺序**（非常重要）：
1. **RENAMED**：先重命名（修改 header）
2. **REMOVED**：再删除（避免重命名后删除错误的内容）
3. **MODIFIED**：再修改（替换现有需求）
4. **ADDED**：最后追加（避免后续修改）

